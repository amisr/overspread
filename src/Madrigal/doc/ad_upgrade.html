<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><!-- InstanceBegin template="/Templates/doc_template.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<!-- InstanceBeginEditable name="doctitle" -->
<title>Upgrading Madrigal</title>
<!-- InstanceEndEditable --><!-- InstanceBeginEditable name="head" --><!-- InstanceEndEditable -->
<link href="madrigal.css" rel="stylesheet" type="text/css" />
<!-- InstanceParam name="href_up_top" type="text" value="admin.html" --><!-- InstanceParam name="href_next_top" type="text" value="ad_metadata.html" --><!-- InstanceParam name="href_back_top" type="text" value="ad_install.html" --><!-- InstanceParam name="href_back_bottom" type="text" value="ad_install.html" --><!-- InstanceParam name="href_up_bottom" type="text" value="admin.html" --><!-- InstanceParam name="href_next_bottom" type="text" value="ad_metadata.html" --><!-- InstanceParam name="href_prev_top" type="text" value="ad_install.html" --><!-- InstanceParam name="href_uptitle_top" type="text" value="admin.html" --><!-- InstanceParam name="href_nexttitle_top" type="text" value="ad_metadata.html" --><!-- InstanceParam name="href_prevtitle_bottom" type="text" value="ad_install.html" --><!-- InstanceParam name="href_uptitle_bottom" type="text" value="admin.html" --><!-- InstanceParam name="href_nexttitle_bottom" type="text" value="ad_metadata.html" -->
</head>

<body>
<table width="100%" border="1" cellpadding="0" cellspacing="2" class="navigation">
  <tr>
    <td width="5%"><a href="ad_install.html"><img src="icons/previous.png" alt="previous" width="32" height="32" /></a></td>
    <td width="5%"><a href="admin.html"><img src="icons/up.png" alt="up" width="32" height="32" /></a></td>
    <td width="5%"><a href="ad_metadata.html"><img src="icons/next.png" alt="next" width="32" height="32" /></a></td>
    <td width="54%"><!-- InstanceBeginEditable name="EditTitleTop" -->Upgrading or moving Madrigal <!-- InstanceEndEditable --></td>
    <td width="13%"><a href="/MADSERVERROOT/madContents.html">Doc home </a></td>
    <td width="18%"><a href="/MADSERVERROOT">Madrigal home</a></td>
  </tr>
</table>
<div class='online-navigation'>
<b class="navlabel">Previous:</b>
<a class="sectref" href="ad_install.html"><!-- InstanceBeginEditable name="PreviousTitle" -->Installing Madrigal <!-- InstanceEndEditable --></A>
<b class="navlabel">&nbsp;&nbsp;Up:</b>
<a class="sectref" href="admin.html"><!-- InstanceBeginEditable name="UpTitle" -->Madrigal admin guide <!-- InstanceEndEditable --></A>
<b class="navlabel">&nbsp;&nbsp;Next:</b>
<a class="sectref" href="ad_metadata.html"><!-- InstanceBeginEditable name="NextTitle" -->Madrigal data model <!-- InstanceEndEditable --></A></div>
<hr/>
<!-- InstanceBeginEditable name="EditDoc" -->
<h1 align="center">Upgrading or moving Madrigal</h1>
<p align="left">With the release of Madrigal 2.5, the procedure to upgrade and/or move Madrigal to a new server was made simpler and less risky. To either upgrade Madrigal on your existing server, or to move it to another server, you now do a clean installation first. This clean installation will not effect your present Madrigal server. If the clean installation succeeds, then you migrate your Madrigal data and make the new server active. If the migration fails for any reason, it is simple to switch back to the original Madrigal server. </p>
<p align="left">To determine what release of Madrigal you are presently running, see the title of the main documentation page (that's the page you get to by clicking on <em>Documentation</em> from the home page). The latest release of Madrigal will always be available from the <a href="http://www.openmadrigal.org/">OpenMadrigal</a> web site via the <a href="http://madrigal.haystack.mit.edu/madrigal/madDownload.html">Download/Update</a> link. </p>
<p align="left">This page covers the following administrative tasks:</p>
<ul>
  <li><a href="#upgrade">Upgrading Madriga</a>l (using the same server)</li>
  <li><a href="#moving">Moving Madrigal to a new server</a> (installs the latest Madrigal version)</li>
</ul>
<p>Three other less common procedures are also listed:</p>
<ul><li><a href="#madroot">Moving the Madrigal madroot directory</a></li>
  <li><a href="#direct">Direct Madrigal upgrade</a> (the old method - no longer recommended)</li>
</ul>
<h3 align="left"><a name="upgrade" id="upgrade"></a>Upgrading Madrigal (using the same server) </h3>
<p align="left">To upgrade Madrigal to the latest release using the same server: </p>
<ol>
  <li>Create a new MADROOT directory for your new installation on your existing Madrigal server. After installation this will be your permanent MADROOT directory (unless you then follow the moving MADROOT procedure). Set your MADROOT environmental variable to this new directory. </li>
  <li>Create two temporary directories on your existing Madrigal server for 1) html files and 2) cgi scripts.  For example, if you standard Madrigal server stores its html files under /var/www/html/madrigal and its cgi files under /var/www/cgi-bin/madrigal, you could create the directories /var/www/html/madrigal2 and /var/www/cgi-bin/madrigal2.</li>
  <li>From <a href="http://www.openmadrigal.org">OpenMadrigal</a>, download the Madrigal distribution file, madrigal*.tar.Z to your MADROOT directory. </li>
  <li>From <a href="http://www.openmadrigal.org">OpenMadrigal</a>, download the sample experiment file, experiments.tar.Z to your MADROOT directory. </li>
  <li>uncompress experiments.tar.Z and madrigal.tar.Z </li>
  <li>tar -xf experiments.tar. </li>
  <li>tar -xf madrigal*.tar.</li>
  <li>Copy madrigal.cfg from the old MADROOT to the new MADROOT, and edit the following <strong>five</strong> fields:
    <ol>
      <li>MADROOT - set to new MADROOT</li>
      <li>MAD<b></b>SERVERROOT - New, temporary url directory relative to MAD<b></b>SERVER for the temporary html files. This directory should not allow files to be executed.   For the &quot;/var/www/html/madrigal2&quot; example, this would be &quot;madrigal2&quot;. </li>
      <li>MAD<b></b>SERVERCGI - New, temporary script directory relative to MAD<b></b>SERVER for temporary cgi files. The web server will need write permission in this directory. This directory should be set to execute only. For the &quot;/var/www/cgi-bin/madrigal2&quot; example , this would be &quot;madrigal2&quot;. </li>
      <li>MAD<b></b>SERVERDOCABS - New, temporary directory (absolute) where  html files should be installed. This directory was created in step 3.</li>
      <li>MAD<b></b>SERVERCGIABS - New, temporary cgi directory. This directory was created in step 3.</li>
    </ol>
  </li>
  <li>In the new MADROOT directory edit metadata/siteTab.txt. This file is comma-delimited. For your site, edit field 4 to be the new MAD<b></b>SERVERROOT set in step 9-2, and field 5 to be the new MAD<b></b>SERVERCGI set in step 9-3. </li>
  <li>Be sure to cd to MADROOT before running the following step. Run  the following command:<br />
      <pre>bash installMadrigal  &amp;&gt; install.log &amp;</pre>
  There may be a long pause when running updateMaster near the end of the installation since the instParmTab.txt metadata file is being built for the first time by examining every data file, but future calls to updateMaster will be much faster since only new experiments are examined. Help with any installation errors is available from the <a href="mailto:madrigal@haystack.mit.edu">OpenMadrigal administrator</a>. </li>
  <li>If there were no errors, test your madrigal installation at the url given by MAD<b></b>SERVERROOT. You can also test it by running MADROOT/bin/python testMadrigalBuild.py, which will test the ability to create plots. </li>
  <li>In the next step you will run a script that will switch the active Madrigal installation to the new installation. 
  By default, it will copy all the experiment data to the new MADROOT directory, so you'll need to make sure there's enough room 
  on the hard drive for two copies of the experiments directory.  If you do not have room for that, you may use the
  --moveExp flag to cause the experiment directory to be moved to the new MADROOT directory,
  rather than copied. This script will also modify madrigal.cfg to use the web paths 
  of the original Madrigal server, and will then install the new cgi scripts and html documents to those original web 
  directories. In this way users will not need to enter a new url to visit your Madrigal site. If any problem emerges 
  with the new version, instructions are given in the next step for switching back to the original Madrigal version. 
  To make the switch, cd to the new MADROOT and run:<br />
      <pre>bin/switchMadrigal [--moveExp] &lt;original_madroot&gt; &lt;new_madroot&gt;</pre>
You should now be able to test the new release of Madrigal at the main Madrigal url.    </li>
  <li>If for any reason you decide you want to switch back to the old version of Madrigal, it is easy to do so. 
  Just export MADROOT to be the old value, cd to the old MADROOT, and run:<br />
<pre>	  tclsh configureHtml
	  tclsh configureScripts
	  bin/updateMaster</pre>
You should now see the old version of Madrigal at the main Madrigal url. If you used the --moveExp flag when
switching in the previous step, you will need to preceed this procedure by moving the experiments back to the
original MADROOT directory and running <i>./configureExperiments</i>.</li>
  <li>There may be reasons  you do not want the value of the MADROOT environmental variable to change when you update Madrigal on the same server. For example, you may have written programs using the Madrigal API that hard-coded the MADROOT value. If, after you are done with the procedure above, you decide you want the new version on Madrigal to run using the old MADROOT value, follow the procedure <a href="#moving">Moving the Madrigal madroot directory</a>. </li>
  <li>This update procedure creates two copies of Madrigal and all the data. Once you are satisfied with the new version of Madrigal, free up disk space by removing:
    <ol>
      <li>The old MADROOT directory</li>
      <li>The temporary MAD<b></b>SERVERROOT  directory created in step 9-2.</li>
      <li>The temporary MAD<b></b>SERVERCGI  directory created in step 9-3. </li>
    </ol>
  </li>
</ol>
<p>&nbsp;</p>
<h3><a name="moving" id="moving"></a>Moving Madrigal to a new server (installs the latest Madrigal version)</h3>
<p>If you want to move Madrigal to a new server, and the main Madrigal url is changing, you should notify the <a href="mailto:madrigal@haystack.mit.edu">OpenMadrigal administrator</a> so that they can update the Madrigal metadata that lists Madrigal sites. If you are moving to a new server but retaining the old Madrigal url, there is no need to change the metadata file <a href="ad_metadata.html#siteTab">siteTab.txt</a>. </p>
<p>In this procedure you will first install a fresh version of Madrigal, and then run a script to import your Madrigal data from your old server. </p>
<ol>
  <li>Install a new version of Madrigal as decribed in <a href="ad_install.html">Installing Madrigal for the first time</a>. You may use your old madrigal.cfg file as a guide, but you will need to change it for the fields that have changed for the new server.</li>
  <li>Once you are happy with the new installation, run the following script from the MADROOT directory of the new Madrigal server: <br />
      <pre>bin/switchMadrigal.py --newUrl &lt;username&gt;@&lt;server&gt;:&lt;original_madroot&gt; &lt;new_madroot&gt;</pre>
  </li>
  <li>Check that all the data from the old Madrigal server now appears on the new server.</li>
  <li>Once you are satisfied with the new installation, you may remove the old installation by removing the following three directories on the old server:
    <ol>
      <li>The  MAD<b></b>SERVERROOT  directory on the old server (specified in old_madroot/madrigal.cfg)</li>
      <li>The  MAD<b></b>SERVERCGI  directory on the old server (specified in old_madroot/madrigal.cfg) </li>
      <li>The old MADROOT directory   </li>
    </ol>
  </li>
</ol>
<h3><a name="madroot" id="madroot"></a>Moving the Madrigal madroot directory</h3>
<p>There may be reasons  you do not want the value of the MADROOT environmental variable to change when you update Madrigal on the same server. For example, you may have written programs using the Madrigal API that hard-coded the MADROOT value. If, after installing Madrigal as described in the <a href="#upgrade">Upgrading Madrigal</a> section, you want to have MADROOT return to its original value, do the following:</p>
<ol>
  <li>Rename the old MADROOT directory to a different name</li>
  <li>Rename the new, active MADROOT directory to the original MADROOT name.</li>
  <li>Set the environmental variable to be the original MADROOT name.</li>
  <li>Edit the MADROOT line in madrigal.cfg to be the original MADROOT name.</li>
  <li>Next you will rerun the installation with the -n flag so that it only does a small subset of the main installtion's tasks. None of the third party python code is rebuilt, which is a major part of the main Madrigal installation time:<br />
    <pre>bash installMadrigal -n &> install.log &</pre>
</li>
  <li>Help with any installation errors is available from the <a href="mailto:madrigal@haystack.mit.edu">OpenMadrigal administrator</a>. </li>
</ol>
<h3 align="left"><a name="direct" id="direct"></a>Direct Upgrade   (no longer recommended) </h3>
<p align="left">To install the latest Madrigal release using the Direct Upgrade method: </p>
<ol>
  <li>Back up all files in MADROOT/metadata. These backups will only be needed if you have modified siteTab.txt or instTab.txt, and not notified the <a href="mailto:madrigal@haystack.mit.edu">OpenMadrigal administrator</a>  about your changes. </li>
  <li>Download the Madrigal distribution file, madrigal*.tar.Z to your MADROOT directory. </li>
  <li>uncompress madrigal*.tar.Z </li>
  <li>tar -xf madrigal*.tar (This will not overwrite any file meant to be modified by a specific Madrigal installation.) </li>
  <li>Compare the new version of madrigal.cfg.template file to your existing madrigal.cfg file found under the MADROOT directory. If any new parameters have been added to the end of the file, add them to you madrigal.cfg file and edit just those entries as described in the <a href="ad_install.html#edit">installation documentation</a>. </li>
  <li>Diff the three backed-up metadata files mentioned in the first step with the installed versions in MADROOT/metadata, and make any changes needed. </li>
  <li>Be sure to cd to MADROOT before running the following step. Then you should be able to complete the installation simply by typing <br />
    <pre>bash installMadrigal &> install.log &</pre>
There may be a long pause when running updateMaster near the end of the installation since the instParmTab.txt metadata file is being built for the first time by examining every data file, but future calls to updateMaster will be much faster since only new experiments are examined. Help with any installation errors is available from the <a href="mailto:madrigal@haystack.mit.edu">OpenMadrigal administrator</a>. </li>
  <li>If there were no errors, your madrigal installation should be running at the url given by MAD<b></b>SERVERROOT. You can also test it by running MADROOT/bin/python testMadrigalBuild.py, which will test the ability to create plots. </li>
  <li>If you want to add any documentation pages specific to your site to the Madrigal documentation pages, see the <a href="ad_other.html#siteSpecific">other admin tasks</a> section of this manual.</li>
  <li>If you want to add your own rules of the road to the Madrigal experiment page, see the <a href="ad_other.html#rules">other admin tasks</a> section of this manual.</li>
</ol>
<!-- InstanceEndEditable -->
<table width="100%" border="1" cellpadding="0" cellspacing="2" class="navigation">
  <tr>
    <td width="5%"><a href="ad_install.html"><img src="icons/previous.png" alt="previous" width="32" height="32" /></a></td>
    <td width="5%"><a href="admin.html"><img src="icons/up.png" alt="up" width="32" height="32" /></a></td>
    <td width="5%"><a href="ad_metadata.html"><img src="icons/next.png" alt="next" width="32" height="32" /></a></td>
    <td width="54%"><!-- InstanceBeginEditable name="EditTitleBottom" -->Upgrading or moving Madrigal <!-- InstanceEndEditable --></td>
    <td width="13%"><a href="/MADSERVERROOT/madContents.html">Doc home </a></td>
    <td width="18%"><a href="/MADSERVERROOT">Madrigal home</a></td>
  </tr>
</table>
<div class='online-navigation'>
<b class="navlabel">Previous:</b>
<a class="sectref" href="ad_install.html"><!-- InstanceBeginEditable name="PreviousTitle2" -->Installing Madrigal <!-- InstanceEndEditable --></A>
<b class="navlabel">&nbsp;&nbsp;Up:</b>
<a class="sectref" href="admin.html"><!-- InstanceBeginEditable name="UpTitle2" -->Madrigal admin guide <!-- InstanceEndEditable --></A>
<b class="navlabel">&nbsp;&nbsp;Next:</b>
<a class="sectref" href="ad_metadata.html"><!-- InstanceBeginEditable name="NextTitle2" -->Madrigal data model <!-- InstanceEndEditable --></A></div>
<hr/>
<p>&nbsp;</p>
</body>
<!-- InstanceEnd --></html>
