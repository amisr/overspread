# Verifies madrigal.cfg has been edited where needed
# Also verifies siteTab.txt has this siteid

# $Id: checkConfig,v 1.4 2009/01/26 14:46:45 brideout Exp $

# usage: tclsh checkConfig

########################
# Start Execution Here #
########################


set fp [open madrigal.cfg r]

# lines required to be verified
set MADROOT_test 0
set MADSERVER_test 0
set MADSERVERROOT_test 0
set MADSERVERCGI_test 0
set MADSERVERDOCABS_test 0
set MADSERVERCGIABS_test 0
set SITEID_test 0
set HTMLSTYLE_test 0
set INDEXHEAD_test 0
set CONTACT_test 0


while {[gets $fp line] >= 0} {

    # MADROOT check
    if {[string range $line 0 8] == "MADROOT ="} {
        set MADROOT [string trim [string range $line 9 end] ]
	set MADROOT_test 1
	if { $MADROOT != $env(PWD) } {
	    puts "MADROOT in madrigal.cfg is $MADROOT, but PWD is $env(PWD)"
	    puts "Fix madrigal.cfg before trying installation again"
	    exit -1
	}
    }
    
    # MADSERVER check
    if {[string range $line 0 10] == "MADSERVER ="} {
        set MADSERVER [string trim [string range $line 11 end]]
        set MADSERVER_test 1
	if { [string match "*invalid*" MADSERVER ] == 1 } {
	    puts "madrigal.cfg MADSERVER entry must be edited - cannot be $MADSERVER"
	    puts "Fix madrigal.cfg before trying installation again"
	    exit -1
	}
    }
    
    # MADSERVERROOT check
    if {[string range $line 0 14] == "MADSERVERROOT ="} {
        set MADSERVERROOT [string trim [string range $line 15 end]]
        set MADSERVERROOT_test 1
    }
    
    # MADSERVERCGI check
    if {[string range $line 0 13] == "MADSERVERCGI ="} {
        set MADSERVERCGI [string trim [string range $line 14 end]]
        set MADSERVERCGI_test 1
    }
    
    # MADSERVERDOCABS check
    if {[string range $line 0 16] == "MADSERVERDOCABS ="} {
        set MADSERVERDOCABS [string trim [string range $line 17 end]]
        set MADSERVERDOCABS_test 1
	if { [file isdirectory  $MADSERVERDOCABS] == 0 } {
	    puts "madrigal.cfg MADSERVERDOCABS entry must be edited - $MADSERVERDOCABS directory does not exist"
	    puts "Fix madrigal.cfg before trying installation again"
	    exit -1
	}
	if { [file writable  $MADSERVERDOCABS] == 0 } {
	    puts "madrigal.cfg MADSERVERDOCABS entry must be writable directory - $MADSERVERDOCABS directory not writable"
	    puts "Fix issue before trying installation again"
	    exit -1
	}
    }
    
    # MADSERVERCGIABS check
    if {[string range $line 0 16] == "MADSERVERCGIABS ="} {
        set MADSERVERCGIABS [string trim [string range $line 17 end]]
        set MADSERVERCGIABS_test 1
	if { [file isdirectory  $MADSERVERCGIABS] == 0 } {
	    puts "madrigal.cfg MADSERVERCGIABS entry must be edited - $MADSERVERCGIABS directory does not exist"
	    puts "Fix madrigal.cfg before trying installation again"
	    exit -1
	}
	if { [file writable  $MADSERVERCGIABS] == 0 } {
	    puts "madrigal.cfg MADSERVERCGIABS entry must be writable directory - $MADSERVERCGIABS directory not writable"
	    puts "Fix issue before trying installation again"
	    exit -1
	}
    }
    
    # SITEID check
    if {[string range $line 0 7] == "SITEID ="} {
        set SITEID [string trim [string range $line 8 end]]
        set SITEID_test 1
	if { [string match "99999" $SITEID ] == 1 } {
	    puts "madrigal.cfg SITEID entry must be edited - cannot be 99999"
	    puts "Fix madrigal.cfg before trying installation again"
	    exit -1
	}
    }
    
    # HTMLSTYLE check
    if {[string range $line 0 10] == "HTMLSTYLE ="} {
        set HTMLSTYLE [string trim [string range $line 11 end]]
        set HTMLSTYLE_test 1
	
	if { [string match -nocase "<*BODY*>" $HTMLSTYLE ] == 0 } {
	    puts "madrigal.cfg HTMLSTYLE entry must be edited - invalid body tag $HTMLSTYLE"
	    puts "Fix madrigal.cfg before trying installation again"
	    exit -1
	}
    }
    
    # INDEXHEAD check
    if {[string range $line 0 10] == "INDEXHEAD ="} {
        set INDEXHEAD [string trim [string range $line 11 end]]
        set INDEXHEAD_test 1
	if { [string match "*CHANGEME*" $INDEXHEAD ] == 1 } {
	    puts "madrigal.cfg INDEXHEAD entry must be edited - cannot include CHANGEME"
	    puts "Fix madrigal.cfg before trying installation again"
	    exit -1
	}
    }
    
    # CONTACT check
    if {[string range $line 0 8] == "CONTACT ="} {
        set CONTACT [string trim [string range $line 9 end]]
        set CONTACT_test 1
	if { [string match "*CHANGEME*" $CONTACT ] == 1 } {
	    puts "madrigal.cfg CONTACT entry must be edited - cannot include CHANGEME"
	    puts "Fix madrigal.cfg before trying installation again"
	    exit -1
	}
    }
    
   
    
    

}

# check that all lines were verified

if { $MADROOT_test != 1 } {
    puts "madrigal.cfg does not contain required variable MADROOT"
    exit -1
} elseif  { $MADSERVER_test != 1 } {
    puts "madrigal.cfg does not contain required variable MADSERVER"
    exit -1
} elseif { $MADSERVERROOT_test != 1 } {
    puts "madrigal.cfg does not contain required variable MADSERVERROOT"
    exit -1
} elseif { $MADSERVERCGI_test != 1 } {
    puts "madrigal.cfg does not contain required variable MADSERVERCGI"
    exit -1
} elseif { $MADSERVERDOCABS_test != 1 } {
    puts "madrigal.cfg does not contain required variable MADSERVERDOCABS"
    exit -1
} elseif { $MADSERVERCGIABS_test != 1 } {
    puts "madrigal.cfg does not contain required variable MADSERVERCGIABS"
    exit -1
} elseif { $SITEID_test != 1 } {
    puts "madrigal.cfg does not contain required variable SITEID"
    exit -1
} elseif { $HTMLSTYLE_test != 1 } {
    puts "madrigal.cfg does not contain required variable HTMLSTYLE"
    exit -1
} elseif { $INDEXHEAD_test != 1 } {
    puts "madrigal.cfg does not contain required variable INDEXHEAD"
    exit -1
} elseif { $CONTACT_test != 1 } {
    puts "madrigal.cfg does not contain required variable CONTACT"
    exit -1
}

close $fp


# now verify that metadata/siteTab.txt has matching entry
set SITEID_OKAY 0
set fsite [open metadata/siteTab.txt r]
while {[gets $fsite line] >= 0} {
    set items [split $line ,]
    if {[llength $line] < 3} {
        continue
    }
    if {[lindex $items 0] == $SITEID} {
        set SITEID_OKAY 1
	break
    } 
}
close $fsite

if {$SITEID_OKAY == 0 } {
    puts "siteTab.txt does not contain an entry for site id $SITEID"
    puts "Edit metadata/siteTab.txt before trying installation again"
    exit -1
}
